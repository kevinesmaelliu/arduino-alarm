<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FFD600">
    <title>Shock Alert - Vibration Controller</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        /* Material 3 Design Tokens - Shock Expressive Theme */
        :root {
            /* Primary Colors - Electric Yellow */
            --md-sys-color-primary: #FFD600;
            --md-sys-color-on-primary: #1A1A1A;
            --md-sys-color-primary-container: #FFF59D;
            --md-sys-color-on-primary-container: #3E2723;

            /* Secondary Colors - Dark Gray */
            --md-sys-color-secondary: #37474F;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #546E7A;
            --md-sys-color-on-secondary-container: #ECEFF1;

            /* Tertiary Colors - Orange Red */
            --md-sys-color-tertiary: #FF6F00;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFCC80;
            --md-sys-color-on-tertiary-container: #3E2723;

            /* Error Colors */
            --md-sys-color-error: #D32F2F;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FFCDD2;
            --md-sys-color-on-error-container: #B71C1C;

            /* Surface Colors - Dark Theme */
            --md-sys-color-surface: #121212;
            --md-sys-color-on-surface: #E0E0E0;
            --md-sys-color-surface-variant: #1E1E1E;
            --md-sys-color-on-surface-variant: #BDBDBD;
            --md-sys-color-surface-container: #1A1A1A;
            --md-sys-color-surface-container-high: #212121;
            --md-sys-color-surface-container-highest: #2C2C2C;

            /* Outline Colors */
            --md-sys-color-outline: #616161;
            --md-sys-color-outline-variant: #424242;

            /* Success Colors - Electric Green */
            --md-sys-color-success: #76FF03;
            --md-sys-color-on-success: #1A1A1A;

            /* Typography Scale */
            --md-sys-typescale-display-large: 57px;
            --md-sys-typescale-display-medium: 45px;
            --md-sys-typescale-display-small: 36px;
            --md-sys-typescale-headline-large: 32px;
            --md-sys-typescale-headline-medium: 28px;
            --md-sys-typescale-headline-small: 24px;
            --md-sys-typescale-title-large: 22px;
            --md-sys-typescale-title-medium: 16px;
            --md-sys-typescale-title-small: 14px;
            --md-sys-typescale-body-large: 16px;
            --md-sys-typescale-body-medium: 14px;
            --md-sys-typescale-body-small: 12px;
            --md-sys-typescale-label-large: 14px;
            --md-sys-typescale-label-medium: 12px;
            --md-sys-typescale-label-small: 11px;

            /* Elevation */
            --md-sys-elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-3: 0px 1px 3px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-4: 0px 2px 3px rgba(0, 0, 0, 0.3), 0px 6px 10px 4px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-5: 0px 4px 4px rgba(0, 0, 0, 0.3), 0px 8px 12px 6px rgba(0, 0, 0, 0.15);

            /* Motion */
            --md-sys-motion-duration-short1: 50ms;
            --md-sys-motion-duration-short2: 100ms;
            --md-sys-motion-duration-short3: 150ms;
            --md-sys-motion-duration-short4: 200ms;
            --md-sys-motion-duration-medium1: 250ms;
            --md-sys-motion-duration-medium2: 300ms;
            --md-sys-motion-duration-medium3: 350ms;
            --md-sys-motion-duration-medium4: 400ms;
            --md-sys-motion-duration-long1: 450ms;
            --md-sys-motion-duration-long2: 500ms;
            --md-sys-motion-easing-standard: cubic-bezier(0.2, 0, 0, 1);
            --md-sys-motion-easing-emphasized: cubic-bezier(0.2, 0, 0, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* App Container */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Top App Bar */
        .top-app-bar {
            background-color: var(--md-sys-color-surface-container);
            padding: 16px 24px;
            border-radius: 28px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--md-sys-elevation-2);
        }

        .app-title {
            font-size: var(--md-sys-typescale-headline-medium);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Connection Badge */
        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: var(--md-sys-typescale-label-large);
            font-weight: 500;
            transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);
        }

        .connection-badge.disconnected {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }

        .connection-badge.connected {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .connection-badge.connecting {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background-color: var(--md-sys-color-error);
        }

        .status-indicator.connected {
            background-color: var(--md-sys-color-success);
        }

        .status-indicator.connecting {
            background-color: var(--md-sys-color-secondary);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        /* Landing Page */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            text-align: center;
            animation: fadeIn var(--md-sys-motion-duration-long2) var(--md-sys-motion-easing-standard);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .landing-icon {
            font-size: 120px;
            color: var(--md-sys-color-primary);
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .landing-title {
            font-size: var(--md-sys-typescale-display-small);
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
        }

        .landing-subtitle {
            font-size: var(--md-sys-typescale-body-large);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 48px;
            max-width: 500px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 24px;
            border: none;
            border-radius: 20px;
            font-size: var(--md-sys-typescale-label-large);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);
            position: relative;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: currentColor;
            opacity: 0;
            transition: opacity var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);
        }

        .btn:hover::before {
            opacity: 0.08;
        }

        .btn:active::before {
            opacity: 0.12;
        }

        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: var(--md-sys-elevation-1);
        }

        .btn-filled:hover {
            box-shadow: var(--md-sys-elevation-2);
        }

        .btn-filled:disabled {
            background-color: rgba(29, 27, 32, 0.12);
            color: rgba(29, 27, 32, 0.38);
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-outlined {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }

        .btn-text {
            background-color: transparent;
            color: var(--md-sys-color-primary);
        }

        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-large {
            padding: 16px 32px;
            font-size: var(--md-sys-typescale-title-medium);
            border-radius: 28px;
        }

        /* Main Content */
        .main-content {
            display: none;
            animation: fadeIn var(--md-sys-motion-duration-long2) var(--md-sys-motion-easing-standard);
        }

        .main-content.active {
            display: block;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* Cards */
        .card {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 28px;
            padding: 24px;
            box-shadow: var(--md-sys-elevation-1);
            transition: all var(--md-sys-motion-duration-medium2) var(--md-sys-motion-easing-standard);
        }

        .card:hover {
            box-shadow: var(--md-sys-elevation-2);
        }

        .card-title {
            font-size: var(--md-sys-typescale-title-large);
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--md-sys-color-on-surface);
        }

        /* Vibration Status */
        .vibration-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .vibration-indicator {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            transition: all var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-emphasized);
            box-shadow: var(--md-sys-elevation-3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vibration-indicator.off {
            background: linear-gradient(135deg, #424242 0%, #212121 100%);
            border: 3px solid var(--md-sys-color-outline);
        }

        .vibration-indicator.on {
            background: linear-gradient(135deg, #FFD600 0%, #FFA000 100%);
            box-shadow: 0 0 60px rgba(255, 214, 0, 0.8), 0 0 100px rgba(255, 214, 0, 0.4), var(--md-sys-elevation-5);
            animation: shockPulse 0.3s ease-in-out infinite, electricGlow 2s ease-in-out infinite;
            border: 3px solid #FFD600;
        }

        @keyframes shockPulse {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.05) rotate(2deg);
            }
            50% {
                transform: scale(0.98) rotate(-2deg);
            }
            75% {
                transform: scale(1.03) rotate(1deg);
            }
        }

        @keyframes electricGlow {
            0%, 100% {
                box-shadow: 0 0 60px rgba(255, 214, 0, 0.8), 0 0 100px rgba(255, 214, 0, 0.4), var(--md-sys-elevation-5);
            }
            50% {
                box-shadow: 0 0 80px rgba(255, 214, 0, 1), 0 0 120px rgba(255, 214, 0, 0.6), var(--md-sys-elevation-5);
            }
        }

        .vibration-indicator .material-symbols-rounded {
            font-size: 80px;
            color: var(--md-sys-color-surface-variant);
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 48;
            position: relative;
            z-index: 2;
        }

        .vibration-indicator.on .material-symbols-rounded {
            color: var(--md-sys-color-on-primary);
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 48;
        }

        .vibration-indicator::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 214, 0, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--md-sys-motion-duration-medium2);
        }

        .vibration-indicator.on::before {
            opacity: 1;
            animation: shockwave 1s ease-out infinite;
        }

        @keyframes shockwave {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Text Fields */
        .text-field {
            position: relative;
            margin-bottom: 24px;
        }

        .text-field label {
            display: block;
            font-size: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .text-field input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 12px;
            font-size: var(--md-sys-typescale-body-large);
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);
        }

        .text-field input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 15px;
        }

        .text-field input:hover {
            border-color: var(--md-sys-color-on-surface);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .quick-action-btn {
            padding: 20px;
            border-radius: 16px;
            font-size: var(--md-sys-typescale-title-small);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn .material-symbols-rounded {
            font-size: 32px;
        }

        /* Manual Controls */
        .manual-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .control-btn {
            padding: 24px;
            border-radius: 20px;
            font-size: var(--md-sys-typescale-title-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-success {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            font-weight: 700;
        }

        .btn-success:hover {
            box-shadow: 0 0 20px rgba(255, 214, 0, 0.5), var(--md-sys-elevation-3);
        }

        .btn-error {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }

        /* Activity Log */
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .activity-log::-webkit-scrollbar {
            width: 8px;
        }

        .activity-log::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-variant);
            border-radius: 4px;
        }

        .activity-log::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 4px;
        }

        .activity-log::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-on-surface-variant);
        }

        .log-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            background-color: var(--md-sys-color-surface);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: var(--md-sys-typescale-body-medium);
            animation: slideIn var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-emphasized);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-item .material-symbols-rounded {
            color: var(--md-sys-color-primary);
        }

        .log-time {
            font-size: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
            margin-left: auto;
        }

        /* Progress Indicator */
        .progress-indicator {
            width: 100%;
            height: 4px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--md-sys-color-primary);
            width: 0%;
            transition: width var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-standard);
        }

        .progress-bar.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s infinite;
        }

        @keyframes indeterminate {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(400%);
            }
        }

        /* Device Status Panel */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .status-item {
            background-color: var(--md-sys-color-surface);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
        }

        .status-label {
            font-size: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
        }

        .status-value {
            font-size: var(--md-sys-typescale-headline-small);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--md-sys-color-on-surface);
            color: var(--md-sys-color-surface);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--md-sys-elevation-3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-emphasized);
        }

        .snackbar.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .top-app-bar {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .app-title {
                font-size: var(--md-sys-typescale-title-large);
            }

            .landing-icon {
                font-size: 80px;
            }

            .landing-title {
                font-size: var(--md-sys-typescale-headline-small);
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .status-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden Class */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top App Bar -->
        <div class="top-app-bar">
            <div class="app-title">
                <span class="material-symbols-rounded">bolt</span>
                Shock Alert
            </div>
            <div class="connection-badge disconnected" id="connectionBadge">
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="connectionText">Disconnected</span>
            </div>
        </div>

        <!-- Landing Page -->
        <div class="landing-page" id="landingPage">
            <span class="material-symbols-rounded landing-icon">bolt</span>
            <h1 class="landing-title">Connect Vibration Device</h1>
            <p class="landing-subtitle">
                Connect to your ESP32 vibration device via Bluetooth to control shock alerts,
                set schedules, and monitor activity in real-time.
            </p>
            <button class="btn btn-filled btn-large" id="connectBtn">
                <span class="material-symbols-rounded">bluetooth_searching</span>
                Connect to Device
            </button>
            <button class="btn btn-outlined btn-large" id="demoBtn" style="margin-top: 16px;">
                <span class="material-symbols-rounded">visibility</span>
                Demo Mode
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Vibration Status & Manual Controls -->
            <div class="grid">
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">vibration</span>
                        Vibration Status
                    </h2>
                    <div class="vibration-status">
                        <div class="vibration-indicator off" id="vibrationIndicator">
                            <span class="material-symbols-rounded">vibration</span>
                        </div>
                    </div>
                    <div class="manual-controls">
                        <button class="btn btn-success control-btn" id="turnOnBtn">
                            <span class="material-symbols-rounded">bolt</span>
                            Activate
                        </button>
                        <button class="btn btn-error control-btn" id="turnOffBtn">
                            <span class="material-symbols-rounded">block</span>
                            Deactivate
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">flash_on</span>
                        Quick Shock Timers
                    </h2>
                    <div class="quick-actions">
                        <button class="btn btn-tonal quick-action-btn" data-minutes="1">
                            <span class="material-symbols-rounded">bolt</span>
                            <span>1 min</span>
                        </button>
                        <button class="btn btn-tonal quick-action-btn" data-minutes="5">
                            <span class="material-symbols-rounded">bolt</span>
                            <span>5 min</span>
                        </button>
                        <button class="btn btn-tonal quick-action-btn" data-minutes="10">
                            <span class="material-symbols-rounded">bolt</span>
                            <span>10 min</span>
                        </button>
                        <button class="btn btn-tonal quick-action-btn" data-minutes="30">
                            <span class="material-symbols-rounded">bolt</span>
                            <span>30 min</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Time Settings -->
            <div class="grid">
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">schedule</span>
                        Set Current Time
                    </h2>
                    <div class="text-field">
                        <label>Current Time</label>
                        <input type="time" id="currentTime" step="1">
                    </div>
                    <button class="btn btn-filled" id="setTimeBtn" style="width: 100%;">
                        <span class="material-symbols-rounded">update</span>
                        Update Time
                    </button>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">alarm_on</span>
                        Shock Schedule
                    </h2>
                    <div class="text-field">
                        <label>Activate At</label>
                        <input type="time" id="onTime">
                    </div>
                    <div class="text-field">
                        <label>Deactivate At</label>
                        <input type="time" id="offTime">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-filled" id="setScheduleBtn" style="flex: 1;">
                            <span class="material-symbols-rounded">check</span>
                            Set Schedule
                        </button>
                        <button class="btn btn-outlined" id="getStatusBtn">
                            <span class="material-symbols-rounded">refresh</span>
                            Status
                        </button>
                    </div>
                </div>
            </div>

            <!-- Device Information -->
            <div class="grid grid-full">
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">info</span>
                        Device Information
                    </h2>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Device Name</div>
                            <div class="status-value" id="deviceName">--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Connection State</div>
                            <div class="status-value" id="connectionState">--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Current Time</div>
                            <div class="status-value" id="deviceTime">--:--:--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Next Action</div>
                            <div class="status-value" id="nextAction">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="grid grid-full">
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">history</span>
                        Activity Log
                    </h2>
                    <div class="activity-log" id="activityLog">
                        <div class="log-item">
                            <span class="material-symbols-rounded">info</span>
                            <span>Ready to receive commands</span>
                            <span class="log-time" id="startTime"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Disconnect Button -->
            <div style="text-align: center; margin-top: 24px;">
                <button class="btn btn-outlined btn-large" id="disconnectBtn">
                    <span class="material-symbols-rounded">bluetooth_disabled</span>
                    Disconnect Device
                </button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar">
        <span class="material-symbols-rounded" id="snackbarIcon">check_circle</span>
        <span id="snackbarText">Action completed</span>
    </div>

    <script>
        // Bluetooth Configuration
        const DEVICE_NAME = 'ESP32_Bluetooth';
        const SERVICE_UUID = 'b67a3bc4-a393-11f0-8de9-0242ac120002';
        const RX_CHARACTERISTIC_UUID = 'cd831e12-a393-11f0-8de9-0242ac120002';
        const TX_CHARACTERISTIC_UUID = 'd289a002-a393-11f0-8de9-0242ac120002';

        // Global variables
        const APP_VERSION = 'ble-monitor-2025-11-11-01';
        const DEBUG = true;
        const debugLog = (...args) => {
            if (DEBUG) {
                console.log('[BLE DEBUG]', ...args);
            }
        };
        debugLog('App script loaded', { version: APP_VERSION });

        let bluetoothDevice = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let isConnected = false;
        let gattServer = null;
        let reconnecting = false;
        let manualDisconnect = false;
        let connectionMonitorInterval = null;
        let commandQueue = [];
        let processingQueue = false;

        const COMMAND_RETRY_DELAY_MS = 150;

        // DOM Elements
        const landingPage = document.getElementById('landingPage');
        const mainContent = document.getElementById('mainContent');
        const connectBtn = document.getElementById('connectBtn');
        const demoBtn = document.getElementById('demoBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionBadge = document.getElementById('connectionBadge');
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionText = document.getElementById('connectionText');
        const vibrationIndicator = document.getElementById('vibrationIndicator');
        const turnOnBtn = document.getElementById('turnOnBtn');
        const turnOffBtn = document.getElementById('turnOffBtn');
        const setTimeBtn = document.getElementById('setTimeBtn');
        const setScheduleBtn = document.getElementById('setScheduleBtn');
        const getStatusBtn = document.getElementById('getStatusBtn');
        const activityLog = document.getElementById('activityLog');
        const snackbar = document.getElementById('snackbar');
        const deviceName = document.getElementById('deviceName');
        const connectionState = document.getElementById('connectionState');
        const deviceTime = document.getElementById('deviceTime');
        const nextAction = document.getElementById('nextAction');
        const quickActionButtons = Array.from(document.querySelectorAll('.quick-action-btn'));
        const interactiveButtons = [
            turnOnBtn,
            turnOffBtn,
            setTimeBtn,
            setScheduleBtn,
            getStatusBtn,
            ...quickActionButtons
        ];

        function setControlsEnabled(enabled) {
            interactiveButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = !enabled;
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set current time
            setCurrentTimeInput();

            // Update start time
            document.getElementById('startTime').textContent = getCurrentTime();

            // Disable control buttons until connected or demo mode
            setControlsEnabled(false);

            // Check if Web Bluetooth is supported
            if (!navigator.bluetooth) {
                showSnackbar('Web Bluetooth is not supported in this browser', 'error');
                connectBtn.disabled = true;
            }
        });

        // Event Listeners
        connectBtn.addEventListener('click', connectToDevice);
        demoBtn.addEventListener('click', enterDemoMode);
        disconnectBtn.addEventListener('click', disconnectDevice);
        turnOnBtn.addEventListener('click', () => {
            if (isConnected) {
                sendCommand('TURN_ON');
            } else {
                // Demo mode - just toggle the UI
                vibrationIndicator.classList.remove('off');
                vibrationIndicator.classList.add('on');
                showSnackbar('Demo: Vibration activated', 'info');
            }
        });
        turnOffBtn.addEventListener('click', () => {
            if (isConnected) {
                sendCommand('TURN_OFF');
            } else {
                // Demo mode - just toggle the UI
                vibrationIndicator.classList.remove('on');
                vibrationIndicator.classList.add('off');
                showSnackbar('Demo: Vibration deactivated', 'info');
            }
        });
        setTimeBtn.addEventListener('click', setCurrentTime);
        setScheduleBtn.addEventListener('click', setSchedule);
        getStatusBtn.addEventListener('click', () => sendCommand('STATUS'));

        // Quick action buttons
        quickActionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const minutes = parseInt(btn.dataset.minutes);
                if (isConnected) {
                    setQuickTimer(minutes);
                } else {
                    // Demo mode
                    vibrationIndicator.classList.remove('off');
                    vibrationIndicator.classList.add('on');
                    showSnackbar(`Demo: ${minutes} minute shock timer activated`, 'info');
                }
            });
        });

        // Enter Demo Mode
        function enterDemoMode() {
            landingPage.style.display = 'none';
            mainContent.classList.add('active');
            deviceName.textContent = 'Demo Device';
            connectionState.textContent = 'Demo Mode';
            showSnackbar('Demo mode activated - test the UI!', 'info');
            addLogEntry('Demo mode activated', 'info');
            setControlsEnabled(true);
        }

        // Connect to Bluetooth Device
        async function connectToDevice() {
            try {
                // Check if Web Bluetooth is available
                if (!navigator.bluetooth) {
                    showSnackbar('Web Bluetooth is not supported in this browser. Please use Chrome, Edge, or Opera.', 'error');
                    addLogEntry('Web Bluetooth not supported', 'error');
                    return;
                }

                debugLog('Starting Bluetooth scan...');
                updateConnectionStatus('connecting');
                addLogEntry('Searching for Bluetooth devices...', 'bluetooth_searching');

                // Request Bluetooth device
                // Option 1: Filter by name (if you know your device name)
                // bluetoothDevice = await navigator.bluetooth.requestDevice({
                //     filters: [{ name: DEVICE_NAME }],
                //     optionalServices: [SERVICE_UUID]
                // });

                // Option 2: Show all Bluetooth devices with the service
                // bluetoothDevice = await navigator.bluetooth.requestDevice({
                //     filters: [{ services: [SERVICE_UUID] }]
                // });

                // Option 3: Show all Bluetooth devices (most permissive)
                debugLog('Requesting Bluetooth device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                debugLog('Device selected:', bluetoothDevice);
                addLogEntry(`Found device: ${bluetoothDevice.name}`, 'check_circle');

                // Connect to GATT Server
                gattServer = await bluetoothDevice.gatt.connect();
                debugLog('GATT server connected:', {
                    connected: gattServer.connected,
                    deviceId: bluetoothDevice.id
                });
                addLogEntry('Connected to GATT server', 'link');

                bluetoothDevice.removeEventListener('gattserverdisconnected', handleDisconnection);
                bluetoothDevice.addEventListener('gattserverdisconnected', handleDisconnection);

                await setupCharacteristics(gattServer);
                manualDisconnect = false;

                // Update UI
                isConnected = true;
                updateConnectionStatus('connected');
                landingPage.style.display = 'none';
                mainContent.classList.add('active');

                deviceName.textContent = bluetoothDevice.name;
                connectionState.textContent = 'Connected';

                showSnackbar('Successfully connected to device', 'success');
                startConnectionMonitor();
                setControlsEnabled(true);
                await processCommandQueue();

                // Get initial status
                setTimeout(() => sendCommand('STATUS'), 1000);

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('disconnected');
                addLogEntry(`Connection failed: ${error.message}`, 'error');
                showSnackbar(`Connection failed: ${error.message}`, 'error');
                debugLog('Connection exception details:', error);
                stopConnectionMonitor();
            }
        }

        // Disconnect Device
        async function disconnectDevice() {
            debugLog('Manual disconnect requested');
            manualDisconnect = true;
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                addLogEntry('Device disconnected', 'bluetooth_disabled');
                debugLog('Manual disconnect complete');
            }

            stopConnectionMonitor();
            setControlsEnabled(false);

            if (txCharacteristic) {
                try {
                    txCharacteristic.removeEventListener('characteristicvaluechanged', handleNotification);
                } catch (err) {
                    console.warn('Failed to remove notification listener', err);
                }
            }

            isConnected = false;
            updateConnectionStatus('disconnected');
            mainContent.classList.remove('active');
            landingPage.style.display = 'flex';

            deviceName.textContent = '--';
            connectionState.textContent = '--';
            deviceTime.textContent = '--:--:--';
            nextAction.textContent = '--';

            rxCharacteristic = null;
            txCharacteristic = null;
            gattServer = null;

            showSnackbar('Device disconnected', 'info');
        }

        // Handle unexpected disconnections
        function handleDisconnection() {
            console.warn('Bluetooth device disconnected');
            debugLog('handleDisconnection fired', {
                manualDisconnect,
                reconnecting,
                devicePresent: !!bluetoothDevice
            });

            if (manualDisconnect) {
                manualDisconnect = false;
                stopConnectionMonitor();
                return;
            }

            isConnected = false;
            rxCharacteristic = null;
            txCharacteristic = null;
            gattServer = null;

            stopConnectionMonitor();

            updateConnectionStatus('disconnected');
            connectionState.textContent = 'Disconnected';
            addLogEntry('Connection lost', 'bluetooth_disabled');
            showSnackbar('Device disconnected. Attempting to reconnect...', 'warning');

            setTimeout(() => {
                debugLog('Triggering reconnect from handleDisconnection');
                attemptReconnect();
            }, 1000);
        }

        function startConnectionMonitor() {
            stopConnectionMonitor();

            connectionMonitorInterval = setInterval(async () => {
                if (!bluetoothDevice || manualDisconnect) {
                    debugLog('Connection monitor skipped', {
                        devicePresent: !!bluetoothDevice,
                        manualDisconnect
                    });
                    return;
                }

                const stillConnected = bluetoothDevice.gatt?.connected && rxCharacteristic;

                if (!stillConnected && !reconnecting) {
                    debugLog('Connection monitor detected drop; attempting reconnect');
                    await attemptReconnect();
                } else {
                    debugLog('Connection monitor heartbeat', {
                        connected: stillConnected,
                        reconnecting
                    });
                }
            }, 5000);

            debugLog('Connection monitor started', { intervalMs: 5000 });

            // Immediate heartbeat log so we see an entry without waiting for the first interval
            if (bluetoothDevice) {
                const stillConnected = bluetoothDevice.gatt?.connected && rxCharacteristic;
                debugLog('Connection monitor initial heartbeat', {
                    connected: stillConnected,
                    reconnecting
                });
            }
        }

        function stopConnectionMonitor() {
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
                connectionMonitorInterval = null;
                debugLog('Connection monitor stopped');
            }
        }

        function enqueueCommand(command, { priority = false } = {}) {
            if (priority) {
                commandQueue.unshift(command);
            } else {
                commandQueue.push(command);
            }
            debugLog('Command queued', { command, queueLength: commandQueue.length, priority });
        }

        async function processCommandQueue() {
            if (processingQueue || commandQueue.length === 0) {
                return;
            }

            if (!await ensureConnected()) {
                debugLog('Queue processing paused - connection not ready');
                return;
            }

            processingQueue = true;
            try {
                debugLog('Processing command queue', { pending: [...commandQueue] });
                const queued = [...commandQueue];
                commandQueue = [];
                for (const cmd of queued) {
                    await sendCommand(cmd, { fromQueue: true });
                    await delay(COMMAND_RETRY_DELAY_MS);
                }
            } finally {
                processingQueue = false;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function ensureConnected() {
            debugLog('ensureConnected invoked', {
                devicePresent: !!bluetoothDevice,
                gattConnected: bluetoothDevice?.gatt?.connected,
                hasRxCharacteristic: !!rxCharacteristic,
                reconnecting
            });
            if (!bluetoothDevice) {
                return false;
            }

            if (bluetoothDevice.gatt.connected && rxCharacteristic) {
                return true;
            }

            return await attemptReconnect();
        }

        async function attemptReconnect() {
            if (!bluetoothDevice || reconnecting || manualDisconnect) {
                debugLog('Skipping attemptReconnect', {
                    devicePresent: !!bluetoothDevice,
                    reconnecting,
                    manualDisconnect
                });
                return false;
            }

            reconnecting = true;
            updateConnectionStatus('connecting');
            addLogEntry('Attempting to reconnect...', 'settings_backup_restore');
            debugLog('attemptReconnect started');

            try {
                gattServer = await bluetoothDevice.gatt.connect();
                debugLog('Reconnected GATT server', {
                    connected: gattServer.connected
                });
                addLogEntry('Reconnected to GATT server', 'link');
                await setupCharacteristics(gattServer);

                isConnected = true;
                updateConnectionStatus('connected');
                connectionState.textContent = 'Connected';
                showSnackbar('Reconnected to device', 'success');
                debugLog('Reconnection successful');
                startConnectionMonitor();
                setControlsEnabled(true);
                await processCommandQueue();
                return true;
            } catch (error) {
                console.error('Reconnection failed:', error);
                addLogEntry(`Reconnect failed: ${error.message}`, 'error');
                showSnackbar(`Reconnect failed: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
                debugLog('Reconnection error details:', error);
                return false;
            } finally {
                debugLog('attemptReconnect finished');
                reconnecting = false;
            }
        }

        async function setupCharacteristics(server) {
            if (!server) {
                debugLog('setupCharacteristics called with no server');
                throw new Error('No GATT server available');
            }

            const service = await server.getPrimaryService(SERVICE_UUID);
            addLogEntry('Service discovered', 'settings');
             debugLog('Primary service obtained');

            if (txCharacteristic) {
                try {
                    txCharacteristic.removeEventListener('characteristicvaluechanged', handleNotification);
                } catch (err) {
                    console.warn('Failed to remove previous notification listener', err);
                    debugLog('Failed removing old notification listener', err);
                }
            }

            rxCharacteristic = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);
            txCharacteristic = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);
            debugLog('Characteristics fetched', {
                hasRx: !!rxCharacteristic,
                hasTx: !!txCharacteristic
            });

            await txCharacteristic.startNotifications();
            txCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);
            addLogEntry('Characteristics configured', 'tune');
            debugLog('Notifications started');
        }

        async function writeCommand(command) {
            if (!rxCharacteristic) {
                throw new Error('RX characteristic unavailable');
            }

            const encoder = new TextEncoder();
            const data = encoder.encode(command);
            const usingWriteWithResponse = typeof rxCharacteristic.writeValueWithResponse === 'function';

            debugLog('Writing to characteristic', {
                length: data.length,
                usingWriteWithResponse
            });

            if (usingWriteWithResponse) {
                await rxCharacteristic.writeValueWithResponse(data);
            } else {
                await rxCharacteristic.writeValue(data);
            }
        }

        // Send Command
        async function sendCommand(command, options = {}) {
            const { fromQueue = false } = options;
            debugLog('sendCommand called', { command, fromQueue });

            if (reconnecting && !fromQueue) {
                enqueueCommand(command);
                showSnackbar('Device reconnecting, command queued', 'info');
                updateConnectionStatus('connecting');
                setControlsEnabled(false);
                return false;
            }

            if (!await ensureConnected()) {
                if (fromQueue) {
                    enqueueCommand(command, { priority: true });
                } else {
                    enqueueCommand(command);
                    showSnackbar('Device reconnecting, command queued', 'warning');
                    updateConnectionStatus('connecting');
                    setControlsEnabled(false);
                }
                return false;
            }

            try {
                await writeCommand(command);

                const logMessage = fromQueue
                    ? `Queued command sent: ${command}`
                    : `Sent: ${command}`;

                addLogEntry(logMessage, 'send');
                debugLog('Command sent successfully', { fromQueue });
                return true;

            } catch (error) {
                console.error('Send error:', error);
                debugLog('Send command error details:', error);

                const isExpectedActivationDrop =
                    command === 'TURN_ON' &&
                    (error.name === 'NotSupportedError' || error.name === 'NetworkError');

                if (isExpectedActivationDrop) {
                    addLogEntry('Activation triggered device reboot - waiting for reconnect', 'warning');
                    showSnackbar('Device restarting after activation...', 'info');
                    enqueueCommand(command, { priority: true });
                } else if (!fromQueue) {
                    addLogEntry(`Send failed: ${error.message}`, 'error');
                    showSnackbar(`Failed to send command: ${error.message}`, 'error');
                } else {
                    enqueueCommand(command, { priority: true });
                }

                isConnected = false;
                rxCharacteristic = null;
                txCharacteristic = null;
                stopConnectionMonitor();
                setControlsEnabled(false);
                updateConnectionStatus('connecting');

                if (!reconnecting) {
                    attemptReconnect();
                }

                return false;
            }
        }

        // Handle Notifications
        function handleNotification(event) {
            const decoder = new TextDecoder();
            const value = decoder.decode(event.target.value);

            addLogEntry(`Received: ${value}`, 'download');

            // Parse response
            parseDeviceResponse(value);
        }

        // Parse Device Response
        function parseDeviceResponse(response) {
            const lower = response.toLowerCase();

            if (lower.includes('on')) {
                vibrationIndicator.classList.remove('off');
                vibrationIndicator.classList.add('on');
            } else if (lower.includes('off')) {
                vibrationIndicator.classList.remove('on');
                vibrationIndicator.classList.add('off');
            }

            // Parse time if present (format: HH:MM:SS)
            const timeMatch = response.match(/(\d{2}):(\d{2}):(\d{2})/);
            if (timeMatch) {
                deviceTime.textContent = timeMatch[0];
            }

            // Parse schedule info
            if (lower.includes('next on:') || lower.includes('turn on at')) {
                const scheduleMatch = response.match(/(\d{2}):(\d{2})/);
                if (scheduleMatch) {
                    nextAction.textContent = `On at ${scheduleMatch[0]}`;
                }
            } else if (lower.includes('next off:') || lower.includes('turn off at')) {
                const scheduleMatch = response.match(/(\d{2}):(\d{2})/);
                if (scheduleMatch) {
                    nextAction.textContent = `Off at ${scheduleMatch[0]}`;
                }
            }
        }

        // Set Current Time
        async function setCurrentTime() {
            const timeInput = document.getElementById('currentTime');
            if (!timeInput.value) {
                showSnackbar('Please enter a time', 'error');
                return;
            }

            const command = `SET_TIME:${timeInput.value}`;
            await sendCommand(command);
            showSnackbar('Time updated', 'success');
        }

        // Set Schedule
        async function setSchedule() {
            const onTimeInput = document.getElementById('onTime');
            const offTimeInput = document.getElementById('offTime');

            if (!onTimeInput.value || !offTimeInput.value) {
                showSnackbar('Please enter both times', 'error');
                return;
            }

            // Send on time
            const onCommand = `SET_ON_TIME:${onTimeInput.value}`;
            await sendCommand(onCommand);

            // Wait a bit before sending next command
            setTimeout(async () => {
                const offCommand = `SET_OFF_TIME:${offTimeInput.value}`;
                await sendCommand(offCommand);
                showSnackbar('Schedule set successfully', 'success');
            }, 500);
        }

        // Set Quick Timer
        async function setQuickTimer(minutes) {
            const now = new Date();
            const offTime = new Date(now.getTime() + minutes * 60000);

            // Turn on immediately
            await sendCommand('TURN_ON');

            // Set off time
            setTimeout(async () => {
                const offTimeStr = offTime.toTimeString().slice(0, 5);
                await sendCommand(`SET_OFF_TIME:${offTimeStr}`);
                showSnackbar(`Timer set for ${minutes} minute${minutes > 1 ? 's' : ''}`, 'success');
            }, 500);
        }

        // Update Connection Status
        function updateConnectionStatus(status) {
            connectionBadge.className = `connection-badge ${status}`;
            statusIndicator.className = `status-indicator ${status}`;

            const statusText = {
                'disconnected': 'Disconnected',
                'connecting': 'Connecting...',
                'connected': 'Connected'
            };

            connectionText.textContent = statusText[status] || status;
        }

        // Add Log Entry
        function addLogEntry(message, icon = 'info') {
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <span class="material-symbols-rounded">${icon}</span>
                <span>${message}</span>
                <span class="log-time">${getCurrentTime()}</span>
            `;

            activityLog.insertBefore(logItem, activityLog.firstChild);

            // Keep only last 50 entries
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }

        // Show Snackbar
        function showSnackbar(message, type = 'info') {
            const snackbarIcon = document.getElementById('snackbarIcon');
            const snackbarText = document.getElementById('snackbarText');

            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'info': 'info',
                'warning': 'warning'
            };

            snackbarIcon.textContent = icons[type] || 'info';
            snackbarText.textContent = message;

            snackbar.classList.add('show');

            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }

        // Get Current Time
        function getCurrentTime() {
            const now = new Date();
            return now.toTimeString().slice(0, 8);
        }

        // Set Current Time Input
        function setCurrentTimeInput() {
            const timeInput = document.getElementById('currentTime');
            timeInput.value = getCurrentTime();
        }

        // Handle device disconnection
        if (navigator.bluetooth) {
            navigator.bluetooth.addEventListener('advertisementreceived', (event) => {
                console.log('Advertisement received:', event);
            });
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('ServiceWorker registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>